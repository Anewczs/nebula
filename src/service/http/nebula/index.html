<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Nebula Test Page</title>
    <script type="module">
        // This is n
        import {NebulaClient} from "./dist/web/main.js";
        var serviceAddr = "http://dev-shawncao:8080";
        var client = new NebulaClient.EchoClient(serviceAddr);

        // simple unary call
        var request = new NebulaClient.EchoRequest();
        request.setName('Trends On Nebula');

        client.echoBack(request, {}, (err, response) => {
            var display = document.getElementById("output");
            if (err !== null) {
                display.innerText = "Error code: " + err;
            } else {
                display.innerText = (response == null) ? "Failed to get reply" : response.getMessage();
            }
        });

        var v1Client = new NebulaClient.V1Client(serviceAddr);
        var req = new NebulaClient.TableStateRequest();
        req.setTable("pin.trends");

        // call the service
        v1Client.state(req, {}, (err, reply) => {
            var result = document.getElementById("result");
            if (err !== null) {
                result.innerText = "Error code: " + err;
            } else if (reply == null) {
                result.innerText = "Failed to get reply";
            } else {
                result.innerText = "Blocks: " + reply.getBlockcount() + ", Rows: " + reply.getRowcount() +
                    ", Size: " + reply.getMemsize() + " bytes";
            }
        });

        // make another query, with time[1548979200 = 02/01/2019, 1556668800 = 05/01/2019]
        var q = new NebulaClient.QueryRequest();
        q.setTable("pin.trends");
        q.setStart(1548979200);
        q.setEnd(1556668800);

        // set constraints
        var p1 = new NebulaClient.Predicate();
        p1.setColumn("count");
        p1.setOp(NebulaClient.Operation.MORE);
        p1.setValueList(["2"]);

        var p2 = new NebulaClient.Predicate();
        p2.setColumn("query");
        p2.setOp(NebulaClient.Operation.LIKE);
        p2.setValueList(["lego %"]);
        var filter = new NebulaClient.PredicateAnd();
        filter.setExpressionList([p1, p2]);
        q.setFiltera(filter);

        // set dimensions
        q.setDimensionList(["query", "_time_"]);
        q.setOrder

        // set metric
        var m = new NebulaClient.Metric();
        m.setColumn("count");
        m.setMethod(NebulaClient.Rollup.SUM);
        q.setMetricList([m]);

        // do the query
        v1Client.query(q, {}, (err, reply) =>{
            var result = document.getElementById("result");
            var json = document.getElementById("json");
            if (err !== null) {
                result.innerText += "Error code: " + err;
            } else if (reply == null) {
                result.innerText += "Failed to get reply";
            } else {
                var stats = reply.getStats();
                result.innerText += "error:" + stats.getError() + ", latency: "+stats.getQuerytimems() + " ms";
                json.innerHTML = NebulaClient.bytes2utf8(reply.getData());
            }
        });
  
    </script>
</head>

<body>
    <p>Response from nebula service: </p>
    <div id="output"></div>

    <input id="tableName" type="text"><input type="button" value="Query" id="btn">
    <div id="result"></div>
    <p>JSON</p>>
    <div id="json"></div>
</body>

</html>