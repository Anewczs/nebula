import{NebulaClient}from"./dist/web/main.js";const d3=NebulaClient.d3,$=NebulaClient.d3.select,$$=e=>$(e).property("value"),serviceAddr="http://dev-shawncao:8080",v1Client=new NebulaClient.V1Client(serviceAddr),formatTime=unix=>{const date=new Date(1e3*unix),y=date.getFullYear(),m=date.getMonth()+1,d=date.getDate();return`${y}-${m}-${d}`},initTable=table=>{const req=new NebulaClient.TableStateRequest;req.setTable(table),v1Client.state(req,{},(err,reply)=>{const stats=$("#stats");if(null!==err)stats.text("Error code: "+err);else if(null==reply)stats.text("Failed to get reply");else{const bc=reply.getBlockcount(),rc=reply.getRowcount(),ms=reply.getMemsize(),mit=formatTime(reply.getMintime()),mat=formatTime(reply.getMaxtime());stats.text(`[Blocks: ${bc}, Rows: ${rc}, Mem: ${ms}, Min T: ${mit}, Max T: ${mat}]`);const dimensions=reply.getDimensionList().filter(v=>"_time_"!==v);$("#dcolumns").html("").selectAll("option").data(dimensions).enter().append("option").text(d=>d).attr("value",d=>d);const metrics=reply.getMetricList().filter(v=>"_time_"!==v);$("#mcolumns").html("").selectAll("option").data(metrics).enter().append("option").text(d=>d).attr("value",d=>d);const all=dimensions.concat(metrics);$("#fcolumns").html("").selectAll("option").data(all).enter().append("option").text(d=>d).attr("value",d=>d)}})},listReq=new NebulaClient.ListTables;listReq.setLimit(5),v1Client.tables(listReq,{},(err,reply)=>{const list=reply.getTableList(),options=$("#tables").selectAll("option").data(list).enter().append("option");options.text(d=>d).attr("value",d=>d),initTable(list[0]),$("#tables").on("change",()=>{initTable($$("#tables"))})});const opFilter=()=>{const op=$$("#fop");switch(op){case"EQ":return NebulaClient.Operation.EQ;case"NEQ":return NebulaClient.Operation.NEQ;case"GT":return NebulaClient.Operation.MORE;case"LT":return NebulaClient.Operation.LESS;case"LK":return NebulaClient.Operation.LIKE}},displayType=()=>{const op=$$("#display");switch(op){case"0":return NebulaClient.DisplayType.TABLE;case"1":return NebulaClient.DisplayType.TIMELINE;case"2":return NebulaClient.DisplayType.BAR;case"3":return NebulaClient.DisplayType.PIE;case"4":return NebulaClient.DisplayType.LINE}},checkRequest=()=>{const display=$$("#display");if("1"===display){const windowSize=$$("#window"),start=new Date($$("#start")).getTime(),end=new Date($$("#end")).getTime(),rangeSeconds=(end-start)/1e3,buckets=rangeSeconds/windowSize;if(buckets>500)return $("#qr").text(`Too many data points to return ${buckets}, please increase window granularity.`),!0}return!1},execute=()=>{const q=new NebulaClient.QueryRequest;q.setTable($$("#tables"));const start=$$("#start"),end=$$("#end");if(!start||!end)return void alert("please enter start and end time");const utStart=new Date(start).getTime()/1e3,utEnd=new Date(end).getTime()/1e3;console.log("start: "+utStart+", end: "+utEnd),q.setStart(utStart),q.setEnd(utEnd);const p2=new NebulaClient.Predicate;p2.setColumn($$("#fcolumns")),p2.setOp(opFilter()),p2.setValueList([$$("#fvalue")]);const filter=new NebulaClient.PredicateAnd;filter.setExpressionList([p2]),q.setFiltera(filter),q.setDimensionList([$$("#dcolumns")]),q.setDisplay(displayType()),q.setWindow($$("#window"));const m=new NebulaClient.Metric,mcol=$$("#mcolumns");m.setColumn(mcol);const rollupType=$$("#ru");switch(rollupType){case"0":m.setMethod(NebulaClient.Rollup.COUNT);break;case"1":m.setMethod(NebulaClient.Rollup.SUM);break;case"2":m.setMethod(NebulaClient.Rollup.MIN);break;case"3":m.setMethod(NebulaClient.Rollup.MAX);break;default:m.setMethod(NebulaClient.Rollup.SUM)}q.setMetricList([m]);const o=new NebulaClient.Order;o.setColumn(mcol);const orderType=$$("#ob");o.setType("1"===orderType?NebulaClient.OrderType.DESC:NebulaClient.OrderType.ASC),q.setOrder(o),q.setTop($$("#limit"));const displayTable=json=>{if(json.length>0){const area=$("#show");area.html("");const tb=area.append("table");tb.append("thead").append("tr").attr("id","table_head"),tb.append("tbody").attr("id","table_content");const keys=Object.keys(json[0]);$("#table_head").selectAll("th").data(keys).enter().append("th").text(d=>d),$("#table_content").selectAll("tr").data(json).enter().append("tr").selectAll("td").data(row=>keys.map(column=>({column:column,value:row[column]}))).enter().append("td").text(d=>d.value)}},displayBar=(json,key,value)=>{const area=$("#show");area.html("");const margin_top=20,margin_right=20,margin_bottom=70,margin_left=40,width=area.node().scrollWidth-margin_left-margin_right,height=600,x=d3.scaleBand().rangeRound([0,width]).paddingInner([.2]).paddingOuter([.4]).align([.5]),y=d3.scaleLinear().range([600,0]),xAxis=d3.axisBottom(x),yAxis=d3.axisLeft(y).ticks(10),svg=area.append("svg").attr("width",width+margin_left+margin_right).attr("height",600+margin_top+margin_bottom).append("g").attr("transform",`translate(${margin_left},${margin_top})`);x.domain(json.map(row=>row[key])),y.domain([0,d3.max(json,row=>row[value])]),svg.append("g").attr("class","x axis").attr("transform","translate(0, 600)").call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.55em").attr("transform","rotate(-45)"),svg.append("g").attr("class","y axis").call(yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Value ($)"),svg.selectAll("bar").data(json).enter().append("rect").style("fill","steelblue").attr("x",row=>x(row[key])).attr("y",row=>y(row[value])).attr("width",x.bandwidth()).attr("height",row=>600-y(row[value]))},displayPie=(json,key,value)=>{const area=$("#show");area.html(""),json.sort((a,b)=>b[value]-a[value]);const top=10;if(json.length>10){json[9][key]="others";for(let i=10;i<json.length;++i)json[9][value]+=json[i][value];json.length=10}const w=area.node().scrollWidth,h=400,r=Math.min(w,h)/2,color=i=>d3.schemeCategory10[i%10],vis=area.append("svg:svg").data([json]).attr("width",w).attr("height",h).append("svg:g").attr("transform",`translate(${w/2},200)`),arc=d3.arc().outerRadius(r-10).innerRadius(0),pie=d3.pie().value(row=>row[value]),arcs=vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class","slice");arcs.append("svg:path").attr("fill",(d,i)=>color(i)).attr("d",arc);const legend=vis.selectAll("g.legend").data(pie).enter().append("svg:g").attr("class","legend").attr("transform",(d,i)=>`translate(${r+100},${20*i-r+20})`);legend.append("svg:rect").attr("width",15).attr("height",15).attr("fill",(d,i)=>color(i)),legend.append("svg:text").attr("text-anchor","left").attr("x",18).attr("y",15).text((d,i)=>json[i][key])},displayLine=(json,value,format)=>{const area=$("#show");area.html("");const margin_top=20,margin_right=50,margin_bottom=20,margin_left=50,width=area.node().scrollWidth-margin_left-margin_right,height=400-margin_top-margin_bottom,x=d3.scaleTime().range([0,width]).domain(d3.extent(json,(d,i)=>i)),y=d3.scaleLinear().range([height,0]).domain([0,d3.max(json,d=>d[value])]);var line=d3.line().x((d,i)=>x(i)).y(d=>y(d[value])),svg=area.append("svg").attr("width",width+margin_left+margin_right).attr("height",height+margin_top+margin_bottom).append("g").attr("transform",`translate(${margin_left}, ${margin_top})`);svg.append("path").data([json]).attr("class","line").attr("d",line),svg.append("g").attr("transform",`translate(0, ${height})`).call(d3.axisBottom(x).tickFormat(format())),svg.append("g").call(d3.axisLeft(y))},extractXY=(json,q)=>{const dims=q.getDimensionList();let metric="";for(const key in json[0])dims.includes(key)||(metric=key);return{d:dims[0],m:metric}},MIN_SECONDS=60,HOUR_SECONDS=3600,DAY_SECONDS=86400,WEEK_SECONDS=604800,timeFormat=unit=>{let fmt="%b,%Y";return unit<60?fmt="%S":unit<3600?fmt="%H:%M:%S":unit<86400?fmt="%H:%M":unit<604800&&(fmt="%m/%d"),d3.timeFormat(fmt)};checkRequest()||v1Client.query(q,{},(err,reply)=>{$("#table_head").html(""),$("#table_content").html("");const result=$("#qr");if(null!==err)result.text("Error code: "+err);else if(null==reply)result.text("Failed to get reply");else{const stats=reply.getStats(),json=JSON.parse(NebulaClient.bytes2utf8(reply.getData()));if(result.text(`[query: error=${stats.getError()}, latency=${stats.getQuerytimems()}ms, rows=${json.length}]`),json.length>0){const display=$$("#display"),keys=extractXY(json,q);switch(display){case"0":displayTable(json);break;case"1":const WINDOW_KEY="_window_",start=new Date($$("#start")).getTime(),window=+$$("#window"),fmt=timeFormat(window);displayLine(json,keys.m,()=>(d,i)=>fmt(new Date(start+1e3*window*json[i][WINDOW_KEY])));break;case"2":displayBar(json,keys.d,keys.m);break;case"3":displayPie(json,keys.d,keys.m);break;case"4":displayLine(json,keys.m,()=>(d,i)=>json[i][keys.d])}}}})};$("#btn").on("click",execute);