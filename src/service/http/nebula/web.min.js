import{NebulaClient}from"./dist/web/main.js";import{Charts}from"./charts.min.js";const d3=NebulaClient.d3,$=NebulaClient.d3.select,$$=e=>$(e).property("value"),serviceAddr="http://dev-shawncao:8080",v1Client=new NebulaClient.V1Client(serviceAddr),formatTime=unix=>{const date=new Date(1e3*unix),y=date.getFullYear(),m=date.getMonth()+1,d=date.getDate();return`${y}-${m}-${d}`},initTable=(table,callback)=>{const req=new NebulaClient.TableStateRequest;req.setTable(table),v1Client.state(req,{},(err,reply)=>{const stats=$("#stats");if(null!==err)stats.text("Error code: "+err);else if(null==reply)stats.text("Failed to get reply");else{const bc=reply.getBlockcount(),rc=reply.getRowcount(),ms=reply.getMemsize(),mit=formatTime(reply.getMintime()),mat=formatTime(reply.getMaxtime());stats.text(`[Blocks: ${bc}, Rows: ${rc}, Mem: ${ms}, Min T: ${mit}, Max T: ${mat}]`);const dimensions=reply.getDimensionList().filter(v=>"_time_"!==v);$("#dcolumns").html("").selectAll("option").data(dimensions).enter().append("option").text(d=>d).attr("value",d=>d);const metrics=reply.getMetricList().filter(v=>"_time_"!==v);$("#mcolumns").html("").selectAll("option").data(metrics).enter().append("option").text(d=>d).attr("value",d=>d);const all=dimensions.concat(metrics);$("#fcolumns").html("").selectAll("option").data(all).enter().append("option").text(d=>d).attr("value",d=>d)}callback&&callback()})},opFilter=op=>{switch(op){case"EQ":return NebulaClient.Operation.EQ;case"NEQ":return NebulaClient.Operation.NEQ;case"GT":return NebulaClient.Operation.MORE;case"LT":return NebulaClient.Operation.LESS;case"LK":return NebulaClient.Operation.LIKE}},displayType=op=>{switch(op){case"0":return NebulaClient.DisplayType.TABLE;case"1":return NebulaClient.DisplayType.TIMELINE;case"2":return NebulaClient.DisplayType.BAR;case"3":return NebulaClient.DisplayType.PIE;case"4":return NebulaClient.DisplayType.LINE}},checkRequest=()=>{const display=$$("#display");if("1"===display){const windowSize=$$("#window"),start=new Date($$("#start")).getTime(),end=new Date($$("#end")).getTime(),rangeSeconds=(end-start)/1e3,buckets=rangeSeconds/windowSize;if(buckets>500)return $("#qr").text(`Too many data points to return ${buckets}, please increase window granularity.`),!0}return!1},hash=v=>(v&&(window.location.hash=v),window.location.hash),build=()=>{const Q={t:$$("#tables"),s:$$("#start"),e:$$("#end"),fv:$$("#fvalue"),fo:$$("#fop"),ff:$$("#fcolumns"),ds:[$$("#dcolumns")],w:$$("#window"),d:$$("#display"),m:$$("#mcolumns"),r:$$("#ru"),o:$$("#ob"),l:$$("#limit")};Q.s&&Q.e?hash("#"+encodeURI(JSON.stringify(Q))):alert("please enter start and end time")},restore=()=>{const h=hash();if(!h||h.length<10)return void console.log(`Bad URL: ${h}`);const p=JSON.parse(decodeURI(h.substr(1))),set=(N,V)=>$(N).property("value",V);p.t&&(set("#tables",p.t),initTable(p.t,()=>{set("#start",p.s),set("#end",p.e),set("#fvalue",p.fv),set("#fop",p.fo),set("#fcolumns",p.ff),set("#dcolumns",p.ds[0]),set("#window",p.w),set("#display",p.d),set("#mcolumns",p.m),set("#ru",p.r),set("#ob",p.o),set("#limit",p.l),execute()}))},seconds=ds=>Math.round(new Date(ds).getTime()/1e3),execute=()=>{const p=JSON.parse(decodeURI(hash().substr(1)));console.log(`Query: ${p}`);const q=new NebulaClient.QueryRequest;q.setTable(p.t),q.setStart(seconds(p.s)),q.setEnd(seconds(p.e));const fvalue=p.fv;if(fvalue){const p2=new NebulaClient.Predicate;p2.setColumn(p.ff),p2.setOp(opFilter(p.fo)),p2.setValueList([fvalue]);const filter=new NebulaClient.PredicateAnd;filter.setExpressionList([p2]),q.setFiltera(filter)}q.setDimensionList(p.ds),q.setDisplay(displayType(p.d)),q.setWindow(p.w);const m=new NebulaClient.Metric,mcol=p.m;m.setColumn(mcol);const rollupType=p.r;switch(rollupType){case"0":m.setMethod(NebulaClient.Rollup.COUNT);break;case"1":m.setMethod(NebulaClient.Rollup.SUM);break;case"2":m.setMethod(NebulaClient.Rollup.MIN);break;case"3":m.setMethod(NebulaClient.Rollup.MAX);break;default:m.setMethod(NebulaClient.Rollup.SUM)}q.setMetricList([m]);const o=new NebulaClient.Order;o.setColumn(mcol);const orderType=p.o;o.setType("1"===orderType?NebulaClient.OrderType.DESC:NebulaClient.OrderType.ASC),q.setOrder(o),q.setTop(p.l);const extractXY=(json,q)=>{const dims=q.getDimensionList();let metric="";for(const key in json[0])dims.includes(key)||(metric=key);return{d:dims[0],m:metric}},MIN_SECONDS=60,HOUR_SECONDS=3600,DAY_SECONDS=86400,WEEK_SECONDS=604800,timeFormat=unit=>{let fmt="%b,%Y";return unit<60?fmt="%S":unit<3600?fmt="%H:%M:%S":unit<86400?fmt="%H:%M":unit<604800&&(fmt="%m/%d/%y"),d3.timeFormat(fmt)};checkRequest()||v1Client.query(q,{},(err,reply)=>{$("#table_head").html(""),$("#table_content").html("");const result=$("#qr");if(null!==err)result.text("Error code: "+err);else if(null==reply)result.text("Failed to get reply");else{const stats=reply.getStats(),json=JSON.parse(NebulaClient.bytes2utf8(reply.getData()));if(result.text(`[query: error=${stats.getError()}, latency=${stats.getQuerytimems()}ms, rows=${json.length}]`),json.length>0){const charts=new Charts,display=$$("#display"),keys=extractXY(json,q);switch(display){case"0":charts.displayTable(json);break;case"1":const WINDOW_KEY="_window_",start=new Date($$("#start")).getTime(),window=+$$("#window"),fmt=timeFormat(window);charts.displayLine(json,keys.m,(scale=1)=>(d,i)=>fmt(new Date(start+1e3*window*json[Math.floor(i*scale)][WINDOW_KEY])));break;case"2":charts.displayBar(json,keys.d,keys.m);break;case"3":charts.displayPie(json,keys.d,keys.m);break;case"4":charts.displayLine(json,keys.m,()=>(d,i)=>json[i][keys.d])}}}})};$("#btn").on("click",build),window.onhashchange=function(){execute()};const listReq=new NebulaClient.ListTables;listReq.setLimit(5),v1Client.tables(listReq,{},(err,reply)=>{const list=reply.getTableList(),options=$("#tables").selectAll("option").data(list).enter().append("option");options.text(d=>d).attr("value",d=>d),initTable(list[0]),$("#tables").on("change",()=>{initTable($$("#tables"))}),setTimeout(restore,50)});